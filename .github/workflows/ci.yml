name: Oracle Portfolio Manager CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build & Test on Windows
    runs-on: windows-latest
    env:
      ORACLE_DB_PATH: data/portfolio.db

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        shell: pwsh
        run: |
          Write-Host "[STEP] Installing dependencies..."
          python -m pip install --upgrade pip
          pip install -r "${{ github.workspace }}/requirements.txt"

      - name: Debug Environment Info
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Python and environment details:"
          python --version
          pip list

          Write-Host "`n[DEBUG] Repository Structure:"
          Get-ChildItem -Path . -Recurse -ErrorAction SilentlyContinue |
            Select-Object FullName |
            ForEach-Object { Write-Host $_.FullName }

      - name: Prepare Database
        shell: pwsh
        run: |
          Write-Host "[STEP] Ensuring /data folder and DB exist..."

          $root = $PWD
          $dbPath = Join-Path $root "data/portfolio.db"
          $schemaFile = Join-Path $root "analytics/sql/migrate_v5_1.sql"
          Write-Host "[INFO] Using schema file: $schemaFile"

          $dbDir = Split-Path $dbPath
          if (-not (Test-Path $dbDir)) {
              New-Item -ItemType Directory -Path $dbDir | Out-Null
              Write-Host "[OK] Created database directory."
          }

          # Create DB if missing
          if (-not (Test-Path $dbPath)) {
              Write-Host "[INFO] Creating new SQLite database..."
              $pythonCode = 'import sqlite3, os; db=r"""' + $dbPath + '"""; os.makedirs(os.path.dirname(db), exist_ok=True); sqlite3.connect(db).close(); print(f"[OK] Created database at {db}")'
              python -c $pythonCode
          } else {
              Write-Host "[INFO] Database already exists."
          }

          # Check for positions table
          Write-Host "[INFO] Checking for positions table..."
          $checkCode = 'import sqlite3, sys; db=r"""' + $dbPath + '"""; conn=sqlite3.connect(db); c=conn.cursor(); c.execute("SELECT name FROM sqlite_master WHERE type=''table'' AND name=''positions''"); print("FOUND" if c.fetchone() else "MISSING"); conn.close()'
          $result = python -c $checkCode

          if ($result -eq "MISSING") {
              Write-Host "[INFO] Applying schema migration..."
              $migrateCode = 'import sqlite3, sys; db=r"""' + $dbPath + '"""; schema=r"""' + $schemaFile + '"""; import os; sql=open(schema,encoding="utf-8").read(); conn=sqlite3.connect(db); conn.executescript(sql); conn.commit(); conn.close(); print("[OK] Schema initialized.")'
              python -c $migrateCode
          } else {
              Write-Host "[INFO] Schema already initialized."
          }

          Write-Host "[OK] Database preparation complete."

      - name: Cache Database
        uses: actions/cache@v4
        with:
          path: data/portfolio.db
          key: portfolio-db-${{ hashFiles('analytics/schema.sql') }}

      - name: Apply DB Migrations
        run: |
          import os
          import glob
          import sqlite3
          import datetime

          # Where CI should place the SQLite DB
          db_path = os.environ.get("ORACLE_DB_PATH", "data/portfolio.db")
          os.makedirs(os.path.dirname(db_path), exist_ok=True)

          print(f"[INFO] Using DB at: {db_path}")

          conn = sqlite3.connect(db_path)
          cur = conn.cursor()

          # Ensure schema_migrations exists
          cur.execute("""
            CREATE TABLE IF NOT EXISTS schema_migrations (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              filename TEXT NOT NULL UNIQUE,
              applied_at TEXT NOT NULL
            )
          """)
          conn.commit()

          migrations_dir = os.path.join("analytics", "sql")
          pattern = os.path.join(migrations_dir, "migrate_*.sql")
          migration_files = sorted(glob.glob(pattern))

          if not migration_files:
            print(f"[WARN] No migration files found under {migrations_dir}")
          else:
            print(f"[INFO] Found {len(migration_files)} migration(s).")

          for path in migration_files:
            filename = os.path.basename(path)

            cur.execute(
              "SELECT 1 FROM schema_migrations WHERE filename = ?",
              (filename,)
            )
            if cur.fetchone():
              print(f"[SKIP] {filename} already applied.")
              continue

            print(f"[APPLY] {filename}")
            with open(path, "r", encoding="utf-8") as f:
              sql = f.read()

            conn.executescript(sql)

            applied_at = datetime.datetime.utcnow().isoformat(timespec="seconds") + "Z"
            cur.execute(
              "INSERT INTO schema_migrations (filename, applied_at) VALUES (?, ?)",
              (filename, applied_at)
            )
            conn.commit()

          conn.close()
          print("[OK] Migrations applied successfully.")
        shell: python {0}
        env:
          # CI DB lives in the repo workspace; adjust if you ever move it
          ORACLE_DB_PATH: data/portfolio.db

      - name: Sanity Check - DB Schema Exists
        shell: pwsh
        run: |
         Write-Host "[STEP] Verifying DB schema integrity..."

         $pythonCode = @"
         import sqlite3, os, sys

         db_path = os.getenv('ORACLE_DB_PATH', 'data/portfolio.db')

         if not os.path.exists(db_path):
             print(f"[ERROR] Database not found at {db_path}")
             sys.exit(1)

         conn = sqlite3.connect(db_path)
         cur = conn.cursor()

         # Check for required tables
         tables = ['positions', 'trades', 'greeks_log']
         cur.execute("SELECT name FROM sqlite_master WHERE type='table';")
         existing = {row[0] for row in cur.fetchall()}

         missing = [t for t in tables if t not in existing]
         if missing:
             print(f"[ERROR] Missing tables: {', '.join(missing)}")
             sys.exit(1)
         else:
             print("[OK] All required tables exist.")

         conn.close()
         "@

         python -c $pythonCode

      - name: Run Smoke Test
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          Write-Host "[STEP] Running smoke test: live_update.py"
          cd automation/python
          python live_update.py

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oracle-logs
          path: logs/
